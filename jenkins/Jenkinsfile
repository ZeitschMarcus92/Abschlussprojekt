pipeline {
  agent any
  environment {
    REGISTRY     = 'docker.io/zeitschmarcus92'
    CREDS_ID     = 'registry-creds'     
    KCFG_DEV     = 'kubeconfig-dev'    
    KCFG_PROD    = 'kubeconfig-prod'    
    IMG_BE       = "${REGISTRY}/app-backend"
    IMG_FE       = "${REGISTRY}/app-frontend"
  }
  parameters {
    choice(name: 'TARGET', choices: ['dev','prod'], description: 'Zielumgebung')
  }
  stages {
    stage('Checkout'){
      steps { checkout scm }
    }
    stage('Build & Test'){
      steps {
        sh 'scripts/build.sh $TARGET'
      }
    }
    stage('Docker & Push'){
      steps {
        withCredentials([usernamePassword(credentialsId: env.CREDS_ID, usernameVariable: 'U', passwordVariable: 'P')]){

          sh 'scripts/push.sh $TARGET "$REGISTRY" "$IMG_BE" "$IMG_FE" "$U" "$P"'
        }
      }
    }
    stage('Deploy'){
      steps {
        script {
          if (params.TARGET == 'dev') {
            withCredentials([file(credentialsId: env.KCFG_DEV, variable: 'K')]) {
              sh 'KUBECONFIG="$K" scripts/deploy.sh dev  "${IMG_BE}:${GIT_COMMIT}" "${IMG_FE}:${GIT_COMMIT}"'
            }
            input 'Promote to PROD?'
            withCredentials([file(credentialsId: env.KCFG_PROD, variable: 'K')]) {
              sh 'KUBECONFIG="$K" scripts/deploy.sh prod "${IMG_BE}:${GIT_COMMIT}" "${IMG_FE}:${GIT_COMMIT}"'
            }
          } else {
            withCredentials([file(credentialsId: env.KCFG_PROD, variable: 'K')]) {
              sh 'KUBECONFIG="$K" scripts/deploy.sh prod "${IMG_BE}:${GIT_COMMIT}" "${IMG_FE}:${GIT_COMMIT}"'
            }
          }
        }
      }
    }
  }
}
